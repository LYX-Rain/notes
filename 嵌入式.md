# 嵌入式

## 嵌入式系统概述

- 嵌入式系统组成：
  - 硬件电路：接口电路、处理器系统电路、系统专用电路
  - 应用软件
  - 实时操作系统
- 嵌入式系统的特点
  - 嵌入性：由于嵌入到对象体系中，必须满足对象系统的环境要求
  - 专用性：嵌入式系统的软、硬件均是面向特定应用对象和任务设计的，具有很强的专用性和多样性
  - 计算机平台：嵌入式系统必须是能满足对象系统控制要求的计算机系统
  - 嵌入式系统的软件固化在非易失性存储器中
  - 嵌入式系统大都有实时性要求，需要在规定的时限内对事件做出正确的反应，如汽车刹车系统

## 计算机体系结构

- 计算机的组成
  - 硬件系统：计算机中那些看得见摸得着的物理实体，是计算机的物质基础，包括计算机内部的电子线路和物理装置
    - 存储器：计算机中用于存放程序和数据的部件
    - 运算器：用于信息处理和运算的部件，它对数据进行算术、逻辑运算。运算器通常由算术逻辑部件（ALU）和一系列寄存器组成。ALU是具体完成算术运算与逻辑运算的部件，寄存器用于存放运算的操作数
    - 控制器是整个计算机的控制机构，其功能就是按照事先确定的步骤，控制运算器、存储器和输入设备、输出设备，统一协调地完成所需要的操作
    - 输入设备：把人们编好的程序和原始数据输送到计算机中去，并且把其转换成计算机内部所能识别和接收的信息
    - 输出设备：将计算机的处理结果以人或其他设备所能理解或接收的形式输出，输出信息的形式同样有字符、文字、图形、图像、声音等
  - 软件系统：
    - 操作系统
    - 语言处理程序
    - 标准库程序
    - 服务性程序

- 计算机系统性能量化：
  - Amdahl定律：加快某部件执行速度所能获得的系统性能加速比，受限于该部件的执行时间占系统中总执行时间的百分比
  - $$系统性能加速比= \frac{系统性能_{改进后}}{系统性能_{改进前}} = \frac{总执行时间_{改进前}}{总执行时间_{改进后}} $$
  - 加速比依赖于两个因素：
    - 可改进比例：在改进前的系统中，可改进部分的执行时间在总的执行时间中所占的比例称为可改进比例，它总是小于等于1。
      - 例如：一个需运行60秒的程序中有20秒的运算可以加速，那么这个比例就是20/60
    - 部件加速比：可改进部分改进以后性能提高的倍数称为部件加速比。它是改进前所需的执行时间与改进后执行时间的比，部件加速比总是大于1。
      - 例如：若系统改进后，可改进部分的执行时间是2秒，而改进前其执行时间为5秒，则部件加速比为5/2
  - $$加速比= \frac{1}{(1-可改进比)+ \frac{可改进比}{部件加速比} }$$
  - Amdahl定律揭示了计算机系统性能改进的两种局限。
    - 第一，部分性能改进的递减局限。即如果仅仅对计算机系统的一部分做性能改进，则改进得越多，所得到的总体性能的提升就越有限。
    - 第二，对计算机系统进行部分性能改进，系统加速比存在极限，极限为1/(1-可改进比例)。
  - CPU性能公式
    - $$CPU时间=程序CPU时钟周期数×时钟周期=\frac{程序的CPU时钟周期数}{时钟频率}$$
    - $$CPU时间=IC×CPI×CCT$$
    - 影响CPU时间的3个性能参数中，CCT主要取决于芯片加工工艺及CPU硬件结构，CPI主要取决于CPU硬件结构及指令集架构（ISA：Instruction Set Architecture），IC则主要取决于ISA和编译技术

## 储存器系统

- 储存器类型：
  - 按照存储介质分类
    - 半导体储存器：速度快，用作内存
      - 记忆原理：通过触发器（如SRAM）、电容（如DRAM）或浮动栅门（如闪存）对电位的保持作用来存储二进制数据
      - 双极型晶体管
      - 场效应管
    - 磁表面存储器：利用涂覆在载体表面的磁性材料具有两种不同的磁化状态来表示“0”和“1”
      - 存储容量大、单位价格低、记录介质可以重复使用、记录信息可以长期保存而不丢失
      - 可以脱机存档、支持非破坏性读出（读出时不会改变存储元的状态）
    - 光存储器：信息以刻痕的形式保存在盘面上，用激光束照射盘面，靠盘面的不同反射率来读出信息
      - 存储密度高、存储寿命长、价格低
  - 按照存取方式分类
    - 随机访问存储器（RAM）
      - 存储单元的内容可按需随意取出或存入，且存取的速度与存储单元的位置无关
      - RAM在断电时将丢失其存储内容
      - RAM可以进一步分为静态随机存储器（SRAM）和动态随机存储器（DRAM）
    - 只读存储器ROM
      - ROM是存储固定信息的存储器，一般是事先写好的，在工作过程中只能读出，不能改写，常用于存储各种固定程序和数据
      - ROM中所存数据在断电后也不会发生改变
    - 顺序存取存储器
      - 在存取信息时，只能按存储单元的位置，顺序地一个接一个地进行数据的存取
    - 按照存储器信息的可保存性分类
      - 根据断电后是否丢失数据，可将存储器分为易失性存储器和非易失性存储器。易失性存储器在断电后，信息就会丢失，例如SRAM。非易失性存储器或称为永久性存储器在断电后，信息不丢失，例如硬盘
      - 根据读出后是否保持数据，可将存储器分为破坏性存储器和非破坏性存储器。破坏性存储器在数据读出时，原存信息会被破坏，需要重新写入，例如DRAM。非破坏性存储器在数据读出时，原存信息不会被破坏，因而也不需要重新写入，大部分存储器都属于这个类型。
    - 高速缓冲存储器（Cache，简称缓存）是存在于主存与CPU之间的一级存储器，容量相对较小但速度比主存高得多，接近于CPU的速度。缓存一般与CPU集成在同一个芯片中，因此也称之为片上存储，一般用SRAM构建
    - 计算机系统中的主要存储器又称内存，用来存储计算机运行期间较常用的大量的程序和数据。主存一般存在于CPU主板上，常用DRAM构建

- 分层存储系统性能
  - 高速缓冲存储器(Cache)是位于主存与CPU之间的高速小容量存储器，用来存放程序中当前最活跃的程序和数据
  - Cache 的命中
    - 当CPU欲访问某主存字时的两种情况：
    1. 所需内容已在Cache中，称为CPU访问Cache 命中，CPU可直接访问Cache
    2. 所需内容不在Cache中，称为CPU访问Cache不命中（失败）。CPU需访问主存获得所需内容，并将包含所需内容的主存块调入Cache中，以备下次访问
  - Cache 命中率：CPU要访问的内容在Cache中的比率
    - 设在一个程序执行期间，访问 Cache 的总命中次数为 Nc，访问主存的次数为 Nm，CPU 访问 Cache 的命中率为H，则有：
    - $$H = \frac{N_c}{N_c+N_m}$$
  - Cache的工作过程
  1. 当CPU需要进行访存时，首先给出主存实地址
  2. 地址映像变换机构接收到主存实地址后，根据块号判定所访问的信息字是否在Cache中
    - 若在(Cache命中)，通过地址变换机构将主存块号变换为Cache块地址，再根据块内偏移量，对Cache进行存取
    - 若不在(Cache不命中)，则通知访问Cache块失效。然后通过CPU与主存之间的直接数据通路访问主存，将被访问字直接送给CPU，并将包含该字的新块装入Cache
  - Cache的地址映像方式
    - 因为CPU以主存地址访问Cache，所以访存时必须把主存地址变换为Cache的实际地址
    1. 直接映像方式
      - 任何一个主存块只能复制到Cache的某一固定块中
      - 直接映像实际是将主存以Cache的大小划分为若干区，每一区的第0块只能复制到Cache的第0块，每一区的第1块只能复制到Cache的第1块，……
      - 采用直接映像方式时，主存地址分成三段：
      - 标识（区号） | 区内块号 | 块内偏移量
        - 标识（区号）用于判断Cache命中与否
        - 区内块号直接用于在Cache中进行块寻址
        - 块内偏移量用于块内字或字节的寻址
        - 地址映像机构在判断块命中与否时，只需判断Cache中某一块对应于主存中哪一区即可
      - 地址变换方式
        - 利用标识Cache中的内容实现地址变换
        - 标识Cache用于存放主存块在Cache中的调入情况。标识Cache共有2m个单元，每个单元对应一个Cache块，每个单元中标识信息长n－m位
        - 主存地址：标识（区号） | 区内块号 | 块内偏移量
        - cache 地址：          |   块号  | 块内偏移量
        - 直接映像下的标识Cache
          - 标识tag（主存区号）| 有效位
      - 直接映像方式的特点：
        1. 硬件线路简单
        2. 地址变换速度快
        3. 因为主存块在Cache中的位置固定，一个主存块只能对应一个Cache块，所以没有替换策略问题
        4. 块的冲突率高，若程序往返访问两个相互冲突的块，将会使命中率急剧下降
        5. Cache利用率低
    2. 全相联映像及变换
      - 任何主存块可映像到任意一个Cache块
      - 地址变换方式
        - 在全相联映像中，主存块号作为标识，块内偏移量作为索引。主存无分区的概念
        - 主存地址：标识（cache标识） | 块内偏移量
        - 在访存操作时，根据主存地址中的块号在标识Cache中查找是否有相同的主存块号
        - 如果有相同的主存块号，则表示Cache命中，根据对应的Cache块号，对Cache进行访问
        - 如果标识Cache中没有相同的主存块号，则表示Cache不命中，需要对主存进行访问并将主存中的块调入Cache中，同时还要将主存块号写入调入的Cache块对应的标识Cache单元中，以改变地址映像关系
        - 在调入新的主存数据块时，需根据替换策略确定将Cache中的哪一个数据块替换出去
      - 全相联映像方式的特点
        1. 块冲突概率小，Cache命中率高
          - 全相联方法只有在Cache中的块全部装满后才会出现块冲突，所以块冲突概率小 
        2. Cache利用率高
        3. 由于需要相联存储器实现相联访问和实现替换策略的硬件，故硬件复杂，成本高
        4. 相联访问影响访问速度
    3. 组相联映像方式
      - 组相联映像是前两种方式的一种折衷方式
      - 先将Cache块分为若干组，每组中有相同数量的Cache块，再将主存块按与Cache组相同的组数进行分组
      - 规定：主存中的任何一组只能映像到Cache中的某一固定组（类似直接映像），但同一组中的主存块可调入Cache中指定组内的任意块中（类似全相联映像）